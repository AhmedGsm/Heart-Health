<!-- File path: index.html (project root folder) -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Client</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
        }
        canvas {
            border: 1px solid #000;
        }
    </style>
</head>

<body>
    <canvas id="ppgCanvas" width="800" height="400"></canvas>
    <!--<h1>WebSocket Example</h1>
    <div class="container">
        <label>Send Message to Server:</label> <br><br>
        <button onclick="sendMessage()">Send</button>
        <div id="output"></div>
    </div>-->

    <script>
        
        // Get the canvas and context
        const canvas = document.getElementById('ppgCanvas');
        const ctx = canvas.getContext('2d');
        // Start drawing
        ctx.beginPath();
        ctx.moveTo(0, 50);

        // Create a WebSocket instance
        // and connect to the server
        const socket = new WebSocket('ws://localhost:81');

        // Event listener for when 
        //the WebSocket connection is opened
        socket.onopen = function (event) {
            // Alert the user that they are 
            // connected to the WebSocket server
            alert('index.html-->You are Connected to WebSocket Server');
        };

        // Event listener for when a message
        //  is received from the server
        socket.onmessage = function (event) {
            receivedData = event.data
            // Get the output div element
            const outputDiv = document
                .getElementById('output');
            // Append a paragraph with the
            //  received message to the output div
            // outputDiv.innerHTML += `<p>index.html... Received <b>"${receivedData}"</b> from server.</p>`;
            //const data = "" + event.data;
            //console.log("typeof data: " + data); // Access the first element

            content = JSON.parse(receivedData);

            // Access the irValues array elements
            // console.log(content); // Access the data array element
            drawPPG(content, 10);
            //console.log("First element of the array is: " + dataArray[1]); // Get the total number of elements
        };

        // Event listener for when the 
        // WebSocket connection is closed
        socket.onclose = function (event) {
            // Log a message when disconnected
            //  from the WebSocket server
            console.log('index.html...Disconnected from WebSocket server');
        };
        
        let x = 0 ;
        let buffer = 0
        let start = 0;
        let end = 0;
        let last_X = 0;
        let last_Y = 0;
        // var y = 0;
        // Function to draw the PPG signal
        function drawPPG(content, timeAxisLength) {
            const width = canvas.width;
            const height = canvas.height;
            const len = content.length;
            const maxVal = Math.max(...content);
            const minVal = Math.min(...content);
            const range = maxVal - minVal;
            const xIncrement = width / len; // Increment x based on the canvas width and number of points

            // Clear the canvas
            // ctx.clearRect(0, 0, width, height);

            // Start drawing
            ctx.beginPath();
            // ctx.moveTo(x, height - ((content[0] - minVal) / range) * height);
            ctx.moveTo(last_X, last_Y);
            let y = 0;
            for (let i = 1; i < len; i++) {
                x += xIncrement / timeAxisLength;
                //x = (i / (len - 1)) * timeAxisLength;
                y = height - ((content[i] - minVal) / range) * height;
                ctx.lineTo(x, y);
            }
            
            last_X = x;
            last_Y = y;

            ctx.strokeStyle = '#007bff';
            ctx.lineWidth = 2;
            ctx.stroke();
            // Clear the plot if it achieves the right of canva
            if(x >= width) {
                x = 0;
                ctx.clearRect(0, 0, width, height);
                last_X = 0;
                last_Y = 0;
            }
        }

        </script>
</body>

</html>
