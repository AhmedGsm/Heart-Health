<!-- File path: index.html (project root folder) -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Client</title>
    <style>
        body {
            /*display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;*/
            background-color: #f0f0f0;
        }

        #container {
            width: 800px;
            padding: 20px;
        }

        canvas {
            border: 1px solid #000;
            display: block;
            margin: 0 auto;
            padding: 15px 0;
        }
    </style>
</head>

<body>
    <div id="container">
        <canvas id="ppgCanvas" width="400" height="200"></canvas>
        <canvas id="ecgCanvas" width="400" height="200"></canvas>
    </div>
    <script>
        class Signal {

            constructor(canvas, ctx, timeAxisLength, strokeStyle, lineWidth) {
                this.x = 0 ;
                this.buffer = 0
                this.start = 0;
                this.end = 0;
                this.last_X = 0;
                this.last_Y = 0;
                this.ctx = ctx;
                this.timeAxisLength = timeAxisLength;
                this.strokeStyle = strokeStyle; //'#007bff';
                this.lineWidth = lineWidth;//2
                this.canvas = canvas;
            }

            // Define a method that draw the signal
            drawSignal(content) {
                const width = this.canvas.width;
                const height = this.canvas.height;
                const len = content.length;
                const maxVal = Math.max(...content);
                const minVal = Math.min(...content);
                const range = maxVal - minVal;
                const xIncrement = width / len; // Increment x based on the canvas width and number of points

                // Start drawing
                this.ctx.beginPath();
                this.ctx.moveTo(0, 50);
                // Clear the canvas
                // ctx.clearRect(0, 0, width, height);

                // Start drawing
                this.ctx.beginPath();
                // ctx.moveTo(x, height - ((content[0] - minVal) / range) * height);
                this.ctx.moveTo(this.last_X, this.last_Y);
                let y = 0;
                for (let i = 1; i < len; i++) {
                    this.x += xIncrement / this.timeAxisLength;
                    //x = (i / (len - 1)) * timeAxisLength;
                    y = height - ((content[i] - minVal) / range) * height;
                    this.ctx.lineTo(this.x, y);
                }
                
                this.last_X = this.x;
                this.last_Y = this.y;

                this.ctx.strokeStyle = this.strokeStyle; //'#007bff';
                this.ctx.lineWidth = this.lineWidth; //2;
                this.ctx.stroke();
                // Clear the plot if it achieves the right of canva
                if(this.x >= width) {
                    this.x = 0;
                    this.ctx.clearRect(0, 0, width, height);
                    this.last_X = 0;
                    this.last_Y = 0;
                }
            }
        }

        // Create a WebSocket instance
        // and connect to the server
        const socket = new WebSocket('ws://localhost:81');
        
        // Event listener for when 
        //the WebSocket connection is opened
        socket.onopen = function (event) {
            // Alert the user that they are 
            // connected to the WebSocket server
            console.log('index.html-->You are Connected to WebSocket Server');
        };
        
        // Get the canvas and context
        let canvasPPG = document.getElementById('ppgCanvas');
        let ctxPPG = canvasPPG.getContext('2d');
        let canvasECG = document.getElementById('ecgCanvas');
        let ctxECG = canvasECG.getContext('2d');
        // Draw signal plot
        let ppgSignal = new Signal(canvasPPG, ctxPPG,  10, '#007bff', 2);
        // Event listener for when a message
        //  is received from the server
        socket.onmessage = function (event) {
            receivedData = event.data
            // Parse received data
            content = JSON.parse(receivedData);
            // Draw signal plot
            //drawSignal(ctxPPG, content, 10 );
            // Draw signal plot
            ppgSignal.drawSignal(content);
            
        };

        // Event listener for when the 
        // WebSocket connection is closed
        socket.onclose = function (event) {
            // Log a message when disconnected
            //  from the WebSocket server
            console.log('index.html...Disconnected from WebSocket server');
        };
        
        /*let x = 0 ;
        let buffer = 0
        let start = 0;
        let end = 0;
        let last_X = 0;
        let last_Y = 0;
        // Function to draw the PPG signal
        function drawSignal(ctx, content, timeAxisLength ) {
            const width = canvas.width;
            const height = canvas.height;
            const len = content.length;
            const maxVal = Math.max(...content);
            const minVal = Math.min(...content);
            const range = maxVal - minVal;
            const xIncrement = width / len; // Increment x based on the canvas width and number of points

            // Start drawing
            ctx.beginPath();
            ctx.moveTo(0, 50);
            // Clear the canvas
            // ctx.clearRect(0, 0, width, height);

            // Start drawing
            ctx.beginPath();
            // ctx.moveTo(x, height - ((content[0] - minVal) / range) * height);
            ctx.moveTo(last_X, last_Y);
            let y = 0;
            for (let i = 1; i < len; i++) {
                x += xIncrement / timeAxisLength;
                //x = (i / (len - 1)) * timeAxisLength;
                y = height - ((content[i] - minVal) / range) * height;
                ctx.lineTo(x, y);
            }
            
            last_X = x;
            last_Y = y;

            ctx.strokeStyle = '#007bff';
            ctx.lineWidth = 2;
            ctx.stroke();
            // Clear the plot if it achieves the right of canva
            if(x >= width) {
                x = 0;
                ctx.clearRect(0, 0, width, height);
                last_X = 0;
                last_Y = 0;
            }
        }*/

        
        </script>
</body>

</html>
